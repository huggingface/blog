---
title: æ¬¢è¿ Stable Diffusion 3.5 Large åŠ å…¥ ğŸ§¨Â Diffusers
thumbnail: /blog/assets/sd3-5/thumbnail.png
authors:
- user: YiYiXu
- user: a-r-r-o-w
- user: dn6
- user: sayakpaul
- user: linoyts
- user: multimodalart
- user: OzzyGT
- user: ariG23498
translators:
- user: hugging-hoi2022
- user: zhongdongy
  proofreader: true
---

# æ¬¢è¿ Stable Diffusion 3.5 Large åŠ å…¥ ğŸ§¨Â Diffusers

ä½œä¸º [Stable Diffusion 3](https://huggingface.co/blog/sd3) çš„æ”¹è¿›ç‰ˆæœ¬ï¼ŒStable Diffusion 3.5 å¦‚ä»Šå·²åœ¨ Hugging Face Hub ä¸­å¯ç”¨ï¼Œå¹¶å¯ä»¥ç›´æ¥ä½¿ç”¨ ğŸ§¨Â Diffusers ä¸­çš„ä»£ç è¿è¡Œã€‚

æœ¬æ¬¡å‘å¸ƒåŒ…å« [ä¸¤å¥—æ¨¡å‹å‚æ•°](https://huggingface.co/collections/stabilityai/stable-diffusion-35-671785cca799084f71fa2838):

- ä¸€ä¸ªå¤§å‹çš„æ¨¡å‹ (largeï¼Œ8B)
- è¯¥æ¨¡å‹ç»è¿‡æ—¶é—´æ­¥è’¸é¦çš„ç‰ˆæœ¬ï¼Œä»…éœ€å‡ æ­¥æ¨ç†å³å¯ç”Ÿæˆå›¾ç‰‡

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•åœ¨ Diffusers ä¸­ä½¿ç”¨ Stable Diffusion 3.5 (SD3.5)ï¼Œæ¶µç›–æ¨ç†å’Œè®­ç»ƒä¸¤æ–¹é¢å†…å®¹ã€‚

## ç›®å½•

- [æ¨¡å‹ç»“æ„æ”¹è¿›](#æ¨¡å‹ç»“æ„æ”¹è¿›)
- [åœ¨ Diffusers ä¸­ä½¿ç”¨ SD3.5](#åœ¨-Diffusers-ä¸­ä½¿ç”¨-SD3.5)
- [åœ¨æ¨ç†è¿‡ç¨‹ä¸­ä½¿ç”¨é‡åŒ–ç­–ç•¥](#åœ¨æ¨ç†è¿‡ç¨‹ä¸­ä½¿ç”¨é‡åŒ–ç­–ç•¥)
- [åœ¨ SD3.5-large ä¸Šä½¿ç”¨é‡åŒ–ç­–ç•¥è®­ç»ƒ LoRA](#åœ¨-SD3.5-large-ä¸Šä½¿ç”¨é‡åŒ–ç­–ç•¥è®­ç»ƒ-LoRA)
- [ä½¿ç”¨ single-file æ–¹æ³•åŠ è½½ SD3.5 çš„ Transformer æ¨¡å‹](#ä½¿ç”¨-single-file-æ–¹æ³•åŠ è½½-SD3.5-çš„-Transformer-æ¨¡å‹)
- [é‡è¦é“¾æ¥](#é‡è¦é“¾æ¥)

## æ¨¡å‹ç»“æ„æ”¹è¿›

å¯¹äº SD3.5-large ä½¿ç”¨çš„ transformer æ¨¡å‹ï¼Œå…¶ç»“æ„åŸºæœ¬å’Œ SD3-medium é‡Œçš„ç›¸åŒï¼Œä½†æœ‰ä»¥ä¸‹æ›´æ”¹:

- QK normalization: å¯¹äºè®­ç»ƒå¤§å‹çš„ Transformer æ¨¡å‹ï¼Œä½¿ç”¨ [QK normalization](https://research.google/blog/scaling-vision-transformers-to-22-billion-parameters/) å·²ç»æˆä¸ºæ ‡å‡†åšæ³•ï¼Œæ‰€ä»¥ SD3.5-large ä¹Ÿä¸ä¾‹å¤–ã€‚
- åŒæ³¨æ„åŠ›å±‚: åœ¨ MMDiT ç»“æ„ä¸­ï¼Œæ–‡æœ¬å’Œå›¾åƒä¸¤ä¸ªæ¨¡æ€éƒ½åœ¨ä½¿ç”¨åŒä¸€ä¸ªæ³¨æ„åŠ›å±‚; è€Œ SD3.5-large åˆ™ä½¿ç”¨äº†ä¸¤ä¸ªæ³¨æ„åŠ›å±‚ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæ–‡æœ¬ç¼–ç å™¨ (text encoder)ã€å›¾åƒçš„å˜åˆ†è‡ªç¼–ç å™¨ (VAE) ä»¥åŠå™ªå£°è°ƒåº¦å™¨ (noise scheduler) å‡å’Œ SD3-medium ä¿æŒä¸€è‡´ã€‚å¦‚æœå¯¹ SD3 æ„Ÿå…´è¶£ï¼Œå¯ä»¥å‚è€ƒ [è¿™ç¯‡è®ºæ–‡](https://arxiv.org/abs/2403.03206)ã€‚

## åœ¨ Diffusers ä¸­ä½¿ç”¨ SD3.5

é¦–å…ˆä½ éœ€è¦ç¡®ä¿å®‰è£…çš„ Diffusers æ˜¯æœ€æ–°ç‰ˆæœ¬:

```bash
pip install -U diffusers
```

ç”±äºæ¨¡å‹å­˜åœ¨è®¿é—®é™åˆ¶ï¼Œä½ è¿˜éœ€è¦åˆ° [Hugging Face ä¸Š Stable Diffusion 3.5 Large çš„é¡µé¢](https://huggingface.co/stabilityai/stable-diffusion-3.5-large) å¡«å†™è¡¨æ ¼å¹¶åŒæ„ç›¸å…³æ¡æ¬¾ã€‚å®Œæˆåä½ è¿˜éœ€è¦ç™»é™†è´¦å·ï¼Œæ‰èƒ½è®¿é—®åˆ°æ¨¡å‹ã€‚ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ç™»é™† Hugging Face è´¦å·:

```bash
huggingface-cli login
```

ä¸‹åˆ—ä»£ç å°†ä¸‹è½½ SD3.5 çš„ 8B æ¨¡å‹ã€‚ä¸‹è½½çš„æ¨¡å‹ä½¿ç”¨ `torch.bfloat16` ç²¾åº¦ï¼Œè¿™æ˜¯ Stability AI çš„åŸç‰ˆæ ¼å¼ï¼Œä¹Ÿæ¨èä½¿ç”¨è¯¥ç²¾åº¦è¿›è¡Œæ¨ç†ã€‚

```python
import torch
from diffusers import StableDiffusion3Pipeline

pipe = StableDiffusion3Pipeline.from_pretrained(
	"stabilityai/stable-diffusion-3.5-large", torch_dtype=torch.bfloat16
).to("cuda")

image = pipe(
    prompt="a photo of a cat holding a sign that says hello world",
    negative_prompt="",
    num_inference_steps=40,
    height=1024,
    width=1024,
    guidance_scale=4.5,
).images[0]

image.save("sd3_hello_world.png")
```

![hello_world_cat](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/sd3-5/hello_world_cat.png)

æœ¬æ¬¡å‘å¸ƒä¹ŸåŒ…å«äº†ä¸€ä¸ª **â€œæ—¶é—´æ­¥è’¸é¦â€** çš„æ¨¡å‹ï¼Œè¯¥æ¨¡å‹æ¨ç†æ—¶æ— éœ€ classifier-free guidanceï¼Œå¯åœ¨çŸ­çŸ­å‡ æ­¥æ¨ç†å†…ç”Ÿæˆå›¾ç‰‡ (é€šå¸¸æ˜¯ 4 åˆ° 8 æ­¥)ã€‚

```python
import torch
from diffusers import StableDiffusion3Pipeline

pipe = StableDiffusion3Pipeline.from_pretrained(
	"stabilityai/stable-diffusion-3.5-large-turbo", torch_dtype=torch.bfloat16
).to("cuda")

image = pipe(
    prompt="a photo of a cat holding a sign that says hello world",
    num_inference_steps=4,
    height=1024,
    width=1024,
    guidance_scale=1.0,
).images[0]

image.save("sd3_hello_world.png")
```

![hello_world_cat_2](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/sd3-5/hello_world_cat_2.png)

æ­¤å¤–ï¼Œåœ¨ [SD3 åšå®¢](https://huggingface.co/blog/zh/sd3) å’Œ [å®˜æ–¹ Diffusers æ–‡æ¡£](https://huggingface.co/docs/diffusers/main/en/api/pipelines/stable_diffusion/stable_diffusion_3) ä¸­å‡ºç°è¿‡çš„ä¼˜åŒ–ç­–ç•¥åœ¨ SD3.5 ä¸­éƒ½å¯ä½¿ç”¨ã€‚ è¿™äº›ç­–ç•¥éƒ½å¯¹æ¨ç†æ—¶æ˜¾å­˜ä¼˜åŒ–åšäº†å¤§é‡å·¥ä½œã€‚ç”±äº SD3.5-large æ˜¯ä¸€ä¸ªæ¯” SD3-medium å¤§å¾—å¤šçš„æ¨¡å‹ï¼Œæ˜¾å­˜ä¼˜åŒ–å¯¹äºæ¶ˆè´¹çº§åœºæ™¯ä¸‹çš„ä½¿ç”¨æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚

## åœ¨æ¨ç†è¿‡ç¨‹ä¸­ä½¿ç”¨é‡åŒ–ç­–ç•¥

Diffusers åŸç”Ÿæ”¯æŒä½¿ç”¨ [`bitsandbytes`](https://github.com/bitsandbytes-foundation/bitsandbytes) è¿›è¡Œé‡åŒ–ï¼Œè¿™å¯ä»¥è¿›ä¸€æ­¥é™ä½æ˜¾å­˜ä½¿ç”¨ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…å¿…è¦çš„åº“:

```bash
pip install -Uq git+https://github.com/huggingface/transformers@main
pip install -Uq bitsandbytes
```

æ¥ä¸‹æ¥åŠ è½½ [â€œNF4â€ç²¾åº¦](https://huggingface.co/blog/4bit-transformers-bitsandbytes) çš„æ¨¡å‹:

```python
from diffusers import BitsAndBytesConfig, SD3Transformer2DModel
import torch

model_id = "stabilityai/stable-diffusion-3.5-large"
nf4_config = BitsAndBytesConfig(
    load_in_4bit=True,
    bnb_4bit_quant_type="nf4",
    bnb_4bit_compute_dtype=torch.bfloat16
)
model_nf4 = SD3Transformer2DModel.from_pretrained(
    model_id,
    subfolder="transformer",
    quantization_config=nf4_config,
    torch_dtype=torch.bfloat16
)
```

ç„¶åæˆ‘ä»¬å°±èƒ½è¿›è¡Œæ¨ç†äº†:

```python
from diffusers import StableDiffusion3Pipeline

pipeline = StableDiffusion3Pipeline.from_pretrained(
    model_id,
    transformer=model_nf4,
    torch_dtype=torch.bfloat16
)
pipeline.enable_model_cpu_offload()

prompt = "A whimsical and creative image depicting a hybrid creature that is a mix of a waffle and a hippopotamus, basking in a river of melted butter amidst a breakfast-themed landscape. It features the distinctive, bulky body shape of a hippo. However, instead of the usual grey skin, the creature's body resembles a golden-brown, crispy waffle fresh off the griddle. The skin is textured with the familiar grid pattern of a waffle, each square filled with a glistening sheen of syrup. The environment combines the natural habitat of a hippo with elements of a breakfast table setting, a river of warm, melted butter, with oversized utensils or plates peeking out from the lush, pancake-like foliage in the background, a towering pepper mill standing in for a tree. As the sun rises in this fantastical world, it casts a warm, buttery glow over the scene. The creature, content in its butter river, lets out a yawn. Nearby, a flock of birds take flight"
image = pipeline(
    prompt=prompt,
    negative_prompt="",
    num_inference_steps=28,
    guidance_scale=4.5,
    max_sequence_length=512,
).images[0]
image.save("whimsical.png")
```

![happy_hippo](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/sd3-5/hippo.png)

å¦‚æœä½ æƒ³è°ƒèŠ‚ `BitsAndBytesConfig` ä¸­å…¶å®ƒé…ç½®ï¼Œä½ å¯ä»¥åœ¨ [è¿™é‡Œ](https://huggingface.co/docs/diffusers/main/en/quantization/bitsandbytes) å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚

ç›´æ¥è½½å…¥ç›¸åŒ `nf4_config` é…ç½®çš„å·²é‡åŒ–æ¨¡å‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™å¯¹ RAM è¾ƒä½çš„æœºå™¨æ¥è¯´éå¸¸å®ç”¨ï¼Œè¯»è€…å¯ä»¥åœ¨ [è¿™é‡Œçš„ Colab Notebook](https://colab.research.google.com/drive/1nK5hOCPY3RoGi0yqddscGdKvo1r-rHqE?usp=sharing) æ¥è·å–å®Œæ•´ç¤ºä¾‹ã€‚

## åœ¨ SD3.5-large ä¸Šä½¿ç”¨é‡åŒ–ç­–ç•¥è®­ç»ƒ LoRA

å€ŸåŠ© `bitsandbytes` å’Œ `peft` ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¶ˆè´¹çº§æ˜¾å¡ (24GB æ˜¾å­˜) ä¸Šå¾®è°ƒåƒ SD3.5 è¿™æ ·çš„å¤§æ¨¡å‹ã€‚æˆ‘ä»¬æä¾›çš„ [SD3 è®­ç»ƒè„šæœ¬](https://huggingface.co/blog/zh/sd3#%E4%BD%BF%E7%94%A8-dreambooth-%E5%92%8C-lora-%E8%BF%9B%E8%A1%8C%E5%BE%AE%E8%B0%83) å¯ä»¥åœ¨è¿™é‡Œç”¨æ¥è®­ç»ƒ LoRAï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å³å¯:

```bash
accelerate launch train_dreambooth_lora_sd3.py \
  --pretrained_model_name_or_path="stabilityai/stable-diffusion-3.5-large" \
  --dataset_name="Norod78/Yarn-art-style" \
  --output_dir="yart_art_sd3-5_lora" \
  --mixed_precision="bf16" \
  --instance_prompt="Frog, yarn art style" \
  --caption_column="text"\
  --resolution=768 \
  --train_batch_size=1 \
  --gradient_accumulation_steps=1 \
  --learning_rate=4e-4 \
  --report_to="wandb" \
  --lr_scheduler="constant" \
  --lr_warmup_steps=0 \
  --max_train_steps=700 \
  --rank=16 \
  --seed="0" \
  --push_to_hub
```

ä½†å¦‚æœæƒ³åœ¨è®­ç»ƒä¸­åŠ å…¥é‡åŒ–ï¼Œè¿˜éœ€è¦è°ƒæ•´ä¸€äº›åœ°æ–¹ï¼Œè¿™åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå¤§æ¦‚æ–¹å‘:

- åœ¨åˆå§‹åŒ–ä»£ç ä¸­çš„ `transformer` æ—¶ï¼ŒåŠ ä¸Šé‡åŒ–é…ç½®ï¼Œæˆ–è€…ç›´æ¥åŠ è½½é‡åŒ–è¿‡çš„æ¨¡å‹ã€‚
- ç„¶åä½¿ç”¨ `peft` ä¸­çš„ `prepare_model_for_kbit_training()` å‡½æ•°å¯¹æ¨¡å‹è¿›è¡Œå‡†å¤‡æ“ä½œã€‚
- å…¶å®ƒæ­¥éª¤å’ŒåŸä»£ç ä¿æŒä¸€è‡´å³å¯ (æ„Ÿè°¢ `peft` å¯¹ `bitsandbytes` çš„å¼ºåŠ›æ”¯æŒ)ã€‚

è¯»è€…å¯å‚è€ƒ [è¿™é‡Œ](https://gist.github.com/sayakpaul/05afd428bc089b47af7c016e42004527) çš„å®Œæ•´ç¤ºä¾‹ã€‚

## ä½¿ç”¨ single-file æ–¹æ³•åŠ è½½ SD3.5 çš„ Transformer æ¨¡å‹

Stable Diffusion 3.5 çš„ transformer æ¨¡å‹è¿˜å¯ä»¥ä½¿ç”¨ Stability AI å‘å¸ƒçš„åŸç”Ÿå‚æ•°æ–‡ä»¶æ¥è¿›è¡Œåˆå§‹åŒ– ã€‚ è¿™é‡Œéœ€è¦ä½¿ç”¨ `from_single_file` æ–¹æ³•:

```python
import torch
from diffusers import SD3Transformer2DModel, StableDiffusion3Pipeline

transformer = SD3Transformer2DModel.from_single_file(
    "https://huggingface.co/stabilityai/stable-diffusion-3.5-large-turbo/blob/main/sd3.5_large.safetensors",
    torch_dtype=torch.bfloat16,
)
pipe = StableDiffusion3Pipeline.from_pretrained(
    "stabilityai/stable-diffusion-3.5-large",
    transformer=transformer,
    torch_dtype=torch.bfloat16,
)
pipe.enable_model_cpu_offload()
image = pipe("a cat holding a sign that says hello world").images[0]
image.save("sd35.png")
```

### é‡è¦é“¾æ¥

- SD3.5-large åœ¨ Hugging Face Hub ä¸Šçš„ [æ¨¡å‹é›†åˆ](https://huggingface.co/collections/stabilityai/stable-diffusion-35-671785cca799084f71fa2838)
- Diffusers ä¸­ SD3.5 çš„ [å®˜æ–¹æ–‡æ¡£](https://huggingface.co/docs/diffusers/main/en/api/pipelines/stable_diffusion/stable_diffusion_3)
- ç”¨æ¥è¿è¡Œ SD3.5 é‡åŒ–æ¨ç†çš„ [Colab Notebook](https://colab.research.google.com/drive/1nK5hOCPY3RoGi0yqddscGdKvo1r-rHqE?usp=sharing)
- LoRA [è®­ç»ƒä»£ç ](https://github.com/huggingface/diffusers/blob/main/examples/dreambooth/README_sd3.md)
- Stable Diffusion 3 [å®˜æ–¹è®ºæ–‡](https://arxiv.org/abs/2403.03206)
- Stable Diffusion 3 [ä¸­æ–‡åšå®¢](https://huggingface.co/blog/zh/sd3)

_å£°æ˜: æ„Ÿè°¢ [Daniel Frank](https://www.pexels.com/@fr3nks/) ä¸ºæœ¬åšå®¢æä¾›äº†å°é¢å›¾ï¼Œæ„Ÿè°¢ [Pedro Cuenca](https://huggingface.co/pcuenq) å’Œ [Tom Aarsen](https://huggingface.co/tomaarsen) å¯¹æœ¬æ–‡çš„å®¡æ ¡ã€‚_