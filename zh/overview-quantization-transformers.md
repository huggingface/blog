---
title: "ğŸ¤— Transformers ä¸­åŸç”Ÿæ”¯æŒçš„é‡åŒ–æ–¹æ¡ˆæ¦‚è¿°" 
thumbnail: /blog/assets/163_overview_quantization_transformers/thumbnail.jpg
authors:
- user: ybelkada
- user: marcsun13
- user: IlyasMoutawwakil
- user: clefourrier
- user: fxmarty
translators:
- user: MatrixYao
- user: zhongdongy
  proofreader: true
---

# ğŸ¤— Transformers ä¸­åŸç”Ÿæ”¯æŒçš„é‡åŒ–æ–¹æ¡ˆæ¦‚è¿°

æœ¬æ–‡æ—¨åœ¨å¯¹ transformers æ”¯æŒçš„å„ç§é‡åŒ–æ–¹æ¡ˆåŠå…¶ä¼˜ç¼ºç‚¹ä½œä¸€ä¸ªæ¸…æ™°çš„æ¦‚è¿°ï¼Œä»¥åŠ©äºè¯»è€…è¿›è¡Œæ–¹æ¡ˆé€‰æ‹©ã€‚

ç›®å‰ï¼Œé‡åŒ–æ¨¡å‹æœ‰ä¸¤ä¸ªä¸»è¦çš„ç”¨é€”:

- åœ¨è¾ƒå°çš„è®¾å¤‡ä¸Šè¿›è¡Œå¤§æ¨¡å‹æ¨ç†
- å¯¹é‡åŒ–æ¨¡å‹è¿›è¡Œé€‚é…å™¨å¾®è°ƒ

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œtransformers å·²ç»é›†æˆå¹¶ **åŸç”Ÿ** æ”¯æŒäº† _bitsandbytes_ å’Œ _auto-gptq_ è¿™ä¸¤ä¸ªé‡åŒ–åº“ã€‚è¯·æ³¨æ„ï¼Œ[ğŸ¤— optimum](https://github.com/huggingface/optimum) è¿˜æ”¯æŒæ›´å¤šçš„é‡åŒ–æ–¹æ¡ˆï¼Œä½†æœ¬æ–‡ä¸ä¼šæ¶‰åŠè¿™ä¸€å—å†…å®¹ã€‚

è¦è¯¦ç»†äº†è§£æ¯ç§æ–¹æ¡ˆçš„æ›´å¤šä¿¡æ¯ï¼Œå¯æŸ¥çœ‹ä¸‹æ–‡åˆ—å‡ºçš„ç›¸å…³èµ„æºï¼Œæˆ–è€…é˜…è¯»ç›¸åº”çš„ `transformers` æ–‡æ¡£ã€‚

å¦è¯·æ³¨æ„ï¼Œä¸‹æ–‡å†…å®¹ä»…é€‚ç”¨äº `PyTorch` æ¨¡å‹ï¼Œ `Tensorflow` å’Œ `Flax/JAX` æ¨¡å‹ä¸åœ¨è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚

## ç›®å½•

- [èµ„æº](#èµ„æº)
- [bitsandbytes ä¸ auto-gptq ä¹‹æ¯”è¾ƒ](#bitsandbytes-ä¸-auto-gptq-ä¹‹æ¯”è¾ƒ)
- [æ·±å…¥ç ”ç©¶é€Ÿåº¦åŸºå‡†](#æ·±å…¥ç ”ç©¶é€Ÿåº¦åŸºå‡†)
- [æ€»ç»“ä¸æœ€åçš„è¯](#æ€»ç»“ä¸æœ€åçš„è¯)
- [è‡´è°¢](#è‡´è°¢)

## èµ„æº

- [GPTQ åšæ–‡](https://huggingface.co/blog/zh/gptq-integration) â€“ æ¦‚è¿°ä»€ä¹ˆæ˜¯ GPTQ é‡åŒ–æ–¹æ³•ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒã€‚
- [bistandbytes 4 æ¯”ç‰¹é‡åŒ–åšæ–‡](https://huggingface.co/blog/zh/4bit-transformers-bitsandbytes) - æœ¬æ–‡ä»‹ç»äº† 4 æ¯”ç‰¹é‡åŒ–å’Œ QLoRaï¼ŒQLoRa æ˜¯ä¸€ç§é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ã€‚
- [bistandbytes 8 æ¯”ç‰¹é‡åŒ–åšæ–‡](https://huggingface.co/blog/zh/hf-bitsandbytes-integration) - æœ¬æ–‡è§£é‡Šäº†å¦‚ä½•ä¸ bitsandbytes é…åˆä½¿ç”¨ 8 æ¯”ç‰¹é‡åŒ–ã€‚
- [æœ‰å…³ GPTQ åŸºç¡€ç”¨æ³•çš„ Google Colab ç¬”è®°æœ¬](https://colab.research.google.com/drive/1_TIrmuKOFhuRRiTWN94iLKUFu6ZX4ceb?usp=sharing) - æœ¬ç¬”è®°æœ¬å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ GPTQ æ–¹æ³•é‡åŒ–ä½ è‡ªå·±çš„ transformer æ¨¡å‹ï¼Œå¦‚ä½•ç”¨é‡åŒ–æ¨¡å‹è¿›è¡Œæ¨ç†ï¼Œä»¥åŠå¦‚ä½•å¯¹é‡åŒ–æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚
- [æœ‰å…³ bitsandbytes åŸºç¡€ç”¨æ³•çš„ Google Colab ç¬”è®°æœ¬](https://colab.research.google.com/drive/1ge2F1QSK8Q7h0hn3YKuBCOAS0bK8E0wf?usp=sharing) - è¯¥ç¬”è®°æœ¬å±•ç¤ºäº†å¦‚ä½•åœ¨æ¨ç†ä¸­ä½¿ç”¨ 4 æ¯”ç‰¹æ¨¡å‹åŠå…¶æ‰€æœ‰å˜ä½“ï¼Œä»¥åŠå¦‚ä½•åœ¨å…è´¹çš„ Google Colab å®ä¾‹ä¸Šè¿è¡Œ GPT-neo-X (20B æ¨¡å‹)ã€‚
- [Merve æ’°å†™çš„å…³äºé‡åŒ–çš„åšæ–‡](https://huggingface.co/blog/merve/quantization) - æœ¬æ–‡ç®€è¦ä»‹ç»äº†é‡åŒ–ä»¥åŠ transformers ä¸­åŸç”Ÿæ”¯æŒçš„é‡åŒ–æ–¹æ³•ã€‚

## bitsandbytes ä¸ auto-gptq ä¹‹æ¯”è¾ƒ

æœ¬èŠ‚æˆ‘ä»¬å°†è®¨è®º `bitsandbytes` å’Œ `gptq` é‡åŒ–å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›æ¯”è¾ƒä¸»è¦åŸºäºç¤¾åŒºçš„åé¦ˆï¼Œå®ƒä»¬å…·æœ‰ä¸€å®šçš„æ—¶æ•ˆæ€§ï¼Œä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå˜åŒ–ï¼Œæ¯”å¦‚è¯´å…¶ä¸­ä¸€äº›åŠŸèƒ½ç¼ºå¤±å·²è¢«çº³å…¥ç›¸åº”åº“çš„è·¯çº¿å›¾ä¸­äº†ã€‚

### bitsandbytes æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

**ç®€å•**: bitsandbytes ä¾æ—§æ˜¯é‡åŒ–ä»»ä½•æ¨¡å‹çš„æœ€ç®€å•æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¸éœ€è¦é‡åŒ–æ ¡å‡†æ•°æ®åŠæ ¡å‡†è¿‡ç¨‹ (å³é›¶æ ·æœ¬é‡åŒ–)ã€‚ä»»ä½•æ¨¡å‹åªè¦å«æœ‰ `torch.nn.Linear` æ¨¡å—ï¼Œå°±å¯ä»¥å¯¹å…¶è¿›è¡Œå¼€ç®±å³ç”¨çš„é‡åŒ–ã€‚æ¯å½“åœ¨ `transformers` ä¸­æ·»åŠ æ–°æ¶æ„æ—¶ï¼Œåªè¦å…¶å¯ä»¥ç”¨ `accelerate` åº“çš„ `device_map="auto"` åŠ è½½ï¼Œç”¨æˆ·å°±å¯ä»¥ç›´æ¥å—ç›Šäºå¼€ç®±å³ç”¨çš„ bitsandbytes é‡åŒ–ï¼ŒåŒæ—¶è¯¥æ–¹æ³•å¯¹æ€§èƒ½çš„å½±å“ä¹Ÿæ˜¯æœ€å°çš„ã€‚é‡åŒ–æ˜¯åœ¨æ¨¡å‹åŠ è½½æ—¶æ‰§è¡Œçš„ï¼Œæ— éœ€è¿è¡Œä»»ä½•åå¤„ç†æˆ–å‡†å¤‡æ­¥éª¤ã€‚

**è·¨æ¨¡æ€äº’æ“ä½œæ€§**: ç”±äºé‡åŒ–æ¨¡å‹çš„å”¯ä¸€æ¡ä»¶æ˜¯åŒ…å« `torch.nn.Linear` å±‚ï¼Œå› æ­¤é‡åŒ–å¯¹äºä»»ä½•æ¨¡æ€éƒ½å¯ä»¥å®ç°å¼€ç®±å³ç”¨ã€‚ç”¨æˆ·å¯ä»¥å¼€ç®±å³ç”¨åœ°åŠ è½½è¯¸å¦‚ Whisperã€ViTã€Blip2 ä¹‹ç±»çš„ 8 æ¯”ç‰¹æˆ– 4 æ¯”ç‰¹æ¨¡å‹ã€‚

**åˆå¹¶é€‚é…å™¨ (adapter) æ—¶æ€§èƒ½ä¸‹é™ä¸º 0**: (å¦‚æœä½ å¯¹æ­¤ä¸ç†Ÿæ‚‰ï¼Œè¯·å‚é˜… [æ­¤æ–‡](https://huggingface.co/blog/zh/peft) ä»¥è·å¾—æœ‰å…³é€‚é…å™¨å’Œ PEFT çš„æ›´å¤šä¿¡æ¯)ã€‚å¦‚æœä½ åœ¨é‡åŒ–åŸºç¡€æ¨¡å‹ä¹‹ä¸Šè®­ç»ƒé€‚é…å™¨ï¼Œåˆ™å¯ä»¥å°†é€‚é…å™¨åˆå¹¶åœ¨åŸºç¡€æ¨¡å‹ä¹‹ä¸Šè¿›è¡Œéƒ¨ç½²ï¼Œè€Œä¸ä¼šé™ä½æ¨ç†æ€§èƒ½ã€‚ä½ ç”šè‡³è¿˜å¯ä»¥åœ¨åé‡åŒ–æ¨¡å‹ä¹‹ä¸Š [åˆå¹¶](https://github.com/huggingface/peft/pull/851/files) é€‚é…å™¨ï¼GPTQ ä¸æ”¯æŒæ­¤åŠŸèƒ½ã€‚

### autoGPTQ æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

**æ–‡æœ¬ç”Ÿæˆé€Ÿåº¦å¿«**: å¯¹ [æ–‡æœ¬ç”Ÿæˆ](https://huggingface.co/docs/transformers/main_classes/text_generation) ä»»åŠ¡è€Œè¨€ï¼ŒGPTQ é‡åŒ–æ¨¡å‹çš„é€Ÿåº¦æ¯” bitsandbytes é‡åŒ–æ¨¡å‹çš„é€Ÿåº¦æ›´å¿«ï¼Œä¸‹æ–‡æˆ‘ä»¬ä¼šè¯¦ç»†æ¯”è¾ƒã€‚

**n æ¯”ç‰¹æ”¯æŒ**: GPTQ ç®—æ³•å¯ä»¥å°†æ¨¡å‹é‡åŒ–è‡³ 2 æ¯”ç‰¹ï¼ä½†è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„è´¨é‡ä¸‹é™ã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨ 4 æ¯”ç‰¹ï¼Œè¿™ä¸ªå€¼å¯¹ GPTQ è€Œè¨€æ˜¯ä¸ªå¾ˆå¥½çš„æŠ˜è¡·ã€‚

**æ˜“äºåºåˆ—åŒ–**: GPTQ æ¨¡å‹æ”¯æŒä»»æ„æ¯”ç‰¹çš„åºåˆ—åŒ–ã€‚åªè¦å®‰è£…äº†æ‰€éœ€çš„è½¯ä»¶åŒ…ï¼Œå°±æ”¯æŒå¼€ç®±å³ç”¨åœ°ä» [TheBloke ç©ºé—´](https://huggingface.co/TheBloke) ä¸­åŠ è½½åç¼€ä¸º `-GPTQ` çš„æ¨¡å‹ã€‚ bitsandbytes æ”¯æŒ 8 æ¯”ç‰¹åºåˆ—åŒ–ï¼Œä½†å°šä¸æ”¯æŒ 4 æ¯”ç‰¹åºåˆ—åŒ–ã€‚

**AMD æ”¯æŒ**: å¼€ç®±å³ç”¨æ”¯æŒ AMD GPUï¼

### bitsandbytes è¿˜æœ‰å“ªäº›æ½œåœ¨çš„æ”¹è¿›ç©ºé—´ï¼Ÿ

**æ–‡æœ¬ç”Ÿæˆé€Ÿåº¦æ¯” GPTQ æ…¢**: ä½¿ç”¨ [`generate`](https://huggingface.co/docs/transformers/main_classes/text_generation) æ¥å£æ—¶ï¼Œbitsandbytes 4 æ¯”ç‰¹æ¨¡å‹æ¯” GPTQ æ…¢ã€‚

**4 æ¯”ç‰¹æƒé‡ä¸å¯åºåˆ—åŒ–**: ç›®å‰ï¼Œ4 æ¯”ç‰¹æ¨¡å‹æ— æ³•åºåˆ—åŒ–ã€‚ç¤¾åŒºç”¨æˆ·ç»å¸¸æå‡ºè¿™æ ·çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ç›¸ä¿¡ bitsandbytes ç»´æŠ¤è€…åº”è¯¥å¾ˆå¿«å°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºè¿™å·²ç»åœ¨å…¶è·¯çº¿å›¾ä¸­äº†ï¼

### autoGPTQ è¿˜æœ‰å“ªäº›æ½œåœ¨çš„æ”¹è¿›ç©ºé—´ï¼Ÿ

**æ ¡å‡†æ•°æ®é›†**: å¯¹æ ¡å‡†æ•°æ®é›†çš„éœ€æ±‚å¯èƒ½ä¼šè®©ä¸€äº›ç”¨æˆ·éš¾ä»¥ç”¨ä¸Š GPTQã€‚æ­¤å¤–ï¼Œæ¨¡å‹é‡åŒ–å¯èƒ½éœ€è¦å‡ ä¸ªå°æ—¶ (ä¾‹å¦‚ï¼Œæ ¹æ® [è¯¥è®ºæ–‡ç¬¬ 2 èŠ‚](https://arxiv.org/pdf/2210.17323.pdf)ï¼Œ175B çš„æ¨¡å‹éœ€è¦ 4 ä¸ª GPU æ—¶)ã€‚

**ç›®å‰ä»…å¯ç”¨äºè¯­è¨€æ¨¡å‹**: æˆªè‡³ç›®å‰ï¼Œç”¨ autoGPTQ å¯¹æ¨¡å‹è¿›è¡Œé‡åŒ–çš„ API ä»…æ”¯æŒè¯­è¨€æ¨¡å‹ã€‚ä½¿ç”¨ GPTQ ç®—æ³•é‡åŒ–éæ–‡æœ¬ (æˆ–å¤šæ¨¡æ€) æ¨¡å‹åº”è¯¥æ˜¯å¯è¡Œçš„ï¼Œä½†åŸå§‹è®ºæ–‡æˆ– auto-gptq ä»£ç åº“ä¸­å°šæœªå¯¹æ­¤æœ‰è¯¦ç»†è¯´æ˜ã€‚å¦‚æœç¤¾åŒºå¯¹è¿™æ–¹é¢å¾ˆæœ‰å…´è¶£ï¼Œå°†æ¥å¯èƒ½ä¼šè€ƒè™‘è¿™ä¸€ç‚¹ã€‚

## æ·±å…¥ç ”ç©¶é€Ÿåº¦åŸºå‡†

æˆ‘ä»¬å†³å®šåœ¨ä¸åŒç¡¬ä»¶ä¸Šä½¿ç”¨ bitsandbytes å’Œ auto-gptq åœ¨æ¨ç†å’Œé€‚é…å™¨å¾®è°ƒè¿™ä¸¤å¤§åœºæ™¯ä¸Šè¿›è¡Œä¸€ç³»åˆ—å¹¿æ³›çš„åŸºå‡†æµ‹è¯•ã€‚æ¨ç†åŸºå‡†æµ‹è¯•åº”è¯¥è®©ç”¨æˆ·äº†è§£ä¸åŒæ¨ç†æ–¹æ³•ä¹‹é—´å¯èƒ½å­˜åœ¨çš„é€Ÿåº¦å·®å¼‚ï¼Œè€Œé€‚é…å™¨å¾®è°ƒåŸºå‡†æµ‹è¯•åº”è¯¥è®©ç”¨æˆ·åœ¨éœ€è¦å†³å®šé€‰æ‹© bitsandbytes è¿˜æ˜¯ GPTQ åŸºç¡€æ¨¡å‹è¿›è¡Œé€‚é…å™¨å¾®è°ƒæ—¶æœ‰ä¸€ä¸ªæ¸…æ™°çš„åˆ¤æ–­ã€‚

åŸºæœ¬è®¾ç½®å¦‚ä¸‹:

- bitsandbytes: ä½¿ç”¨ `bnb_4bit_compute_dtype=torch.float16` è¿›è¡Œ 4 æ¯”ç‰¹é‡åŒ–ã€‚ç¡®ä¿ä½¿ç”¨ `bitsandbytes>=0.41.1` ï¼Œä»¥ç”¨ä¸Š 4 æ¯”ç‰¹åŠ é€Ÿæ ¸å‡½æ•°ã€‚
- auto-gptq: ç¡®ä¿ `auto-gptq>=0.4.0` ä»¥ç”¨ä¸Š `exllama` åŠ é€Ÿæ ¸å‡½æ•°è¿›è¡Œ 4 æ¯”ç‰¹é‡åŒ–ã€‚

### æ¨ç†é€Ÿåº¦ (ä»…å‰å‘)

è¯¥åŸºå‡†æµ‹è¯•ä»…æµ‹é‡é¢„å¡«å…… (prefill) æ­¥éª¤ï¼Œè¯¥æ­¥éª¤å¯¹åº”äºè®­ç»ƒæœŸé—´çš„å‰å‘ä¼ é€’ã€‚æµ‹è¯•åŸºäºå•å¼ è‹±ä¼Ÿè¾¾ A100-SXM4-80GB GPUï¼Œæç¤ºé•¿åº¦ä¸º 512ï¼Œæ¨¡å‹ä¸º `meta-llama/Llama-2-13b-hf` ã€‚

batch size = 1 æ—¶:

| é‡åŒ–æ–¹æ³• | act_order | æ¯”ç‰¹æ•° | group_size | åŠ é€Ÿæ ¸ | åŠ è½½æ—¶é—´ (ç§’) | æ¯è¯å…ƒå»¶è¿Ÿ (æ¯«ç§’) | åå (è¯å…ƒ/ç§’) | å³°å€¼æ˜¾å­˜ (MB) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| fp16 | None | None | None | None | 26.0 | 36.958 | 27.058 | 29152.98 |
| gptq | False | 4 | 128 | exllama | 36.2 | 33.711 | 29.663 | 10484.34 |
| bitsandbytes | None | 4 | None | None | 37.64 | 52.00 | 19.23 | 11018.36 |

batch size = 16 æ—¶:

| é‡åŒ–æ–¹æ³• | act_order | æ¯”ç‰¹æ•° | group_size | åŠ é€Ÿæ ¸ | åŠ è½½æ—¶é—´ (ç§’) | æ¯è¯å…ƒå»¶è¿Ÿ (æ¯«ç§’) | åå (è¯å…ƒ/ç§’) | å³°å€¼æ˜¾å­˜ (MB) |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| fp16 | None | None | None | None | 26.0 | 69.94 | 228.76 | 53986.51 |
| gptq | False | 4 | 128 | exllama | 36.2 | 95.41 | 167.68 | 34777.04 |
| bitsandbytes | None | 4 | None | None | 37.64 | 113.98 | 140.38 | 35532.37 |

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œbitsandbyes å’Œ GPTQ çš„é¢„å¡«å……é€Ÿåº¦ç›¸å½“ï¼Œbatch size æ¯”è¾ƒå¤§æ—¶ GPTQ ç¨å¿«ä¸€äº›ã€‚æ¬²äº†è§£æœ‰å…³è¯¥åŸºå‡†æµ‹è¯•çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤ [é“¾æ¥](https://github.com/huggingface/optimum/blob/main/tests/benchmark/README.md#prefill-only-benchmark-results)ã€‚

### ç”Ÿæˆé€Ÿåº¦

ä¸‹é¢æµ‹è¯•æ¨ç†è¿‡ç¨‹ä¸­æ¨¡å‹çš„ç”Ÿæˆé€Ÿåº¦ï¼Œä½ å¯ä»¥åœ¨ [æ­¤å¤„](https://gist.github.com/younesbelkada/e576c0d5047c0c3f65b10944bc4c651c) æ‰¾åˆ°åŸºå‡†æµ‹è¯•è„šæœ¬ï¼Œç”¨äºé‡ç°æˆ‘ä»¬çš„ç»“æœã€‚

#### use_cache

æˆ‘ä»¬å…ˆæµ‹è¯• `use_cache` å‚æ•°çš„å½±å“ï¼Œä»¥æ›´å¥½åœ°äº†è§£åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­é”®å€¼ç¼“å­˜å¯¹é€Ÿåº¦çš„å½±å“ã€‚

è¯¥åŸºå‡†æµ‹è¯•åœ¨ A100 ä¸Šè¿è¡Œï¼Œæç¤ºé•¿åº¦ä¸º 30ï¼Œç”Ÿæˆè¯å…ƒæ•°ä¹Ÿä¸º 30ï¼Œæ¨¡å‹ä¸º `meta-llama/Llama-2-7b-hf` ã€‚

`use_cache=True` æ—¶:

![use_cache=True A100 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_use_cache_True.jpg)

`use_cache=False` æ—¶:

![use_cache=False A100 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_use_cache_False.jpg)

é€šè¿‡è¿™ä¸¤ä¸ªåŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼Œä½¿ç”¨æ³¨æ„åŠ›ç¼“å­˜æ—¶ï¼Œç”Ÿæˆé€Ÿåº¦ä¼šæ›´å¿«ï¼Œè¯¥ç»“è®ºç¬¦åˆé¢„æœŸã€‚æ­¤å¤–ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒGPTQ æ¯” bitsandbytes æ›´å¿«ã€‚ä¾‹å¦‚ï¼Œ `batch_size=4` ä¸” `use_cache=True` æ—¶ï¼ŒGPTQ é€Ÿåº¦å¿«äº†ä¸€å€ï¼å› æ­¤ï¼Œæˆ‘ä»¬ä¸‹ä¸€ä¸ªåŸºå‡†æµ‹è¯•ä¸­ä¼šç›´æ¥ä½¿ç”¨ `use_cache=True` ã€‚è¯·æ³¨æ„ï¼Œ `use_cache=True` ä¼šæ¶ˆè€—æ›´å¤šæ˜¾å­˜ã€‚

#### ç¡¬ä»¶

ä¸‹é¢ï¼Œæˆ‘ä»¬çœ‹çœ‹é‡åŒ–æ¨¡å‹åœ¨ä¸åŒçš„ç¡¬ä»¶ä¸Šçš„è¡¨ç°ã€‚æˆ‘ä»¬ä½¿ç”¨çš„æç¤ºé•¿åº¦ä¸º 30ï¼Œç”Ÿæˆ 30 ä¸ªè¯å…ƒï¼Œä½¿ç”¨çš„æ¨¡å‹æ˜¯ `meta-llama/Llama-2-7b-hf` ã€‚

å•å¼  A100:

![A100 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_use_cache_True.jpg)

å•å¼  T4:

![T4 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/T4.jpg)

å•å¼  Titan RTX:

![TITAN RTX åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/RTX_Titan.jpg)

ä»ä¸Šé¢çš„åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå¯¹äºè¿™ä¸‰æ¬¾ GPUï¼ŒGPTQ éƒ½æ¯” bitsandbytes æ›´å¿«ã€‚

#### ç”Ÿæˆé•¿åº¦

åœ¨ä¸‹é¢çš„åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å°†å°è¯•ä¸åŒçš„ç”Ÿæˆé•¿åº¦ï¼Œçœ‹çœ‹å®ƒä»¬å¯¹é‡åŒ–æ¨¡å‹é€Ÿåº¦çš„å½±å“ã€‚å®éªŒåŸºäº A100ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æç¤ºé•¿åº¦ä¸º 30ï¼Œå¹¶æ”¹å˜ç”Ÿæˆè¯å…ƒçš„é•¿åº¦ã€‚ä½¿ç”¨çš„æ¨¡å‹æ˜¯ `meta-llama/Llama-2-7b-hf` ã€‚

ç”Ÿæˆ 30 ä¸ªè¯å…ƒ:

![A100 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_use_cache_True.jpg)

ç”Ÿæˆ 512 ä¸ªè¯å…ƒ:

![ç”Ÿæˆ 512 ä¸ªè¯å…ƒçš„ A100 åŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_max_token_512.jpg)

ä»ä»¥ä¸ŠåŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ— è®ºç”Ÿæˆé•¿åº¦å¦‚ä½•ï¼ŒGPTQ éƒ½æ¯” bitsandbytes æ›´å¿«ã€‚

### é€‚é…å™¨å¾®è°ƒ (å‰å‘ + åå‘)

å¯¹é‡åŒ–æ¨¡å‹è¿›è¡Œå…¨æ¨¡å‹å¾®è°ƒæ˜¯ä¸å¯èƒ½çš„ã€‚ä½†æ˜¯ï¼Œä½ å¯ä»¥åˆ©ç”¨å‚æ•°é«˜æ•ˆå¾®è°ƒ (PEFT) æ¥å¾®è°ƒé‡åŒ–æ¨¡å‹ï¼Œåœ¨å…¶ä¹‹ä¸Šè®­ç»ƒæ–°çš„é€‚é…å™¨ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ç§åä¸ºâ€œä½ç§©é€‚é…å™¨ (LoRA)â€çš„å¾®è°ƒæ–¹æ³•: æ— éœ€å¾®è°ƒæ•´ä¸ªæ¨¡å‹ï¼Œä»…éœ€å¾®è°ƒè¿™äº›é€‚é…å™¨å¹¶å°†å®ƒä»¬æ­£ç¡®åŠ è½½åˆ°æ¨¡å‹ä¸­ã€‚æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹å¾®è°ƒé€Ÿåº¦å§ï¼

è¯¥åŸºå‡†æµ‹è¯•åŸºäºè‹±ä¼Ÿè¾¾ A100 GPUï¼Œæˆ‘ä»¬ä½¿ç”¨ Hub ä¸­çš„ `meta-llama/Llama-2-7b-hf` æ¨¡å‹ã€‚è¯·æ³¨æ„ï¼Œå¯¹äº GPTQ æ¨¡å‹ï¼Œæˆ‘ä»¬å¿…é¡»ç¦ç”¨ `exllama` åŠ é€Ÿæ ¸ï¼Œå› ä¸ºå®ƒä¸æ”¯æŒå¾®è°ƒã€‚

![A100 å¾®è°ƒåŸºå‡†æµ‹è¯•ç»“æœ](https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/163_overview-quantization-transformers/A100_finetuning.png)

ä»ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œbitsandbytes çš„å¾®è°ƒé€Ÿåº¦æ¯” GPTQ æ›´å¿«ã€‚

### æ€§èƒ½é€€åŒ–

é‡åŒ–å¯¹äºå‡å°‘å†…å­˜æ¶ˆè€—éå¸¸æœ‰ç”¨ã€‚ç„¶è€Œï¼Œå®ƒä¹Ÿä¼šå¸¦æ¥æ€§èƒ½é€€åŒ–ã€‚æˆ‘ä»¬ä½¿ç”¨ [Open-LLM æ’è¡Œæ¦œ](https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard) æ¥æ¯”è¾ƒæ€§èƒ½ï¼

å¯¹äº 7B æ¨¡å‹:

| æ¨¡å‹ | å‡å€¼ | ARC | Hellaswag | MMLU | TruthfulQA |
|------------------------------------|---------|-------|-----------|-------|------------|
| meta-llama/llama-2-7b-hf           | **54.32**   | 53.07 | 78.59     | 46.87 | 38.76      |
| meta-llama/llama-2-7b-hf-bnb-4bit  | **53.4**    | 53.07 | 77.74     | 43.8  | 38.98      |
| TheBloke/Llama-2-7B-GPTQ           | **53.23**   | 52.05 | 77.59     | 43.99 | 39.32      |

å¯¹äº 13B æ¨¡å‹:

| æ¨¡å‹ | å‡å€¼ | ARC | Hellaswag | MMLU | TruthfulQA |
|------------------------------------|---------|-------|-----------|-------|------------|
| meta-llama/llama-2-13b-hf          | **58.66**   | 59.39 | 82.13     | 55.74 | 37.38      |
| TheBloke/Llama-2-13B-GPTQ (revision = 'gptq-4bit-128g-actorder_True')| **58.03**   | 59.13 | 81.48     | 54.45 | 37.07      |
| TheBloke/Llama-2-13B-GPTQ          | **57.56**   | 57.25 | 81.66     | 54.81 | 36.56      |
| meta-llama/llama-2-13b-hf-bnb-4bit | **56.9**    | 58.11 | 80.97     | 54.34 | 34.17      |

ä»ä¸Šé¢çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ¨¡å‹è¶Šå¤§ï¼Œé€€åŒ–è¶Šå°‘ã€‚æ›´æœ‰æ„æ€çš„æ˜¯ï¼Œæ‰€æœ‰çš„é€€åŒ–éƒ½å¾ˆå°ï¼

## æ€»ç»“ä¸æœ€åçš„è¯

é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¯”è¾ƒäº†å¤šç§è®¾ç½®ä¸‹çš„ bitsandbytes å’Œ GPTQ é‡åŒ–ã€‚æˆ‘ä»¬å‘ç°ï¼Œbitsandbytes æ›´é€‚åˆå¾®è°ƒï¼Œè€Œ GPTQ æ›´é€‚åˆç”Ÿæˆã€‚æ ¹æ®è¿™ä¸€è§‚å¯Ÿï¼Œè·å¾—æœ€ä½³åˆå¹¶æ¨¡å‹çš„ä¸€ç§æ–¹æ³•æ˜¯:

- (1) ä½¿ç”¨ bitsandbytes é‡åŒ–åŸºç¡€æ¨¡å‹ (é›¶æ ·æœ¬é‡åŒ–)
- (2) æ·»åŠ å¹¶å¾®è°ƒé€‚é…å™¨
- (3) å°†è®­ç»ƒåçš„é€‚é…å™¨åˆå¹¶åˆ°åŸºç¡€æ¨¡å‹æˆ– [åé‡åŒ–æ¨¡å‹](https://github.com/huggingface/peft/pull/851/files) ä¹‹ä¸­ï¼
- (4) ä½¿ç”¨ GPTQ é‡åŒ–åˆå¹¶åçš„æ¨¡å‹å¹¶å°†å…¶ç”¨äºéƒ¨ç½²

æˆ‘ä»¬å¸Œæœ›è¿™ä¸ªæ¦‚è¿°è®©æ¯ä¸ªäººéƒ½èƒ½æ›´è½»æ¾åœ°å°† LLM åº”ç”¨è‡³å„è‡ªçš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æœŸå¾…çœ‹åˆ°å¤§å®¶ç”¨å®ƒæ„å»ºè‡ªå·±çš„æœ‰è¶£åº”ç”¨ï¼

## è‡´è°¢

æˆ‘ä»¬è¦æ„Ÿè°¢ [Ilyas](https://huggingface.co/IlyasMoutawwakil)ã€[ClÃ©mentine](https://huggingface.co/clefourrier) å’Œ [Felix](https://huggingface.co/fxmarty) åœ¨åŸºå‡†æµ‹è¯•ä¸Šçš„å¸®åŠ©ã€‚

æˆ‘ä»¬è¿˜è¦æ„Ÿè°¢ [Pedro Cuenca](https://github.com/pcuenca) å¯¹æœ¬æ–‡æ’°å†™çš„å¸®åŠ©ã€‚